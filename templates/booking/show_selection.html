{% extends 'base.html' %}
{% load static %}
{% block title %}
<title>Book a Show - Morro_Cine</title>
<link rel="stylesheet" href="{% static 'css/seat_selection.css' %}">
{% endblock %}
{% block content %}
<div class="container" id="movie-content" style="animation: fadeIn 0.5s ease-in;">
    <h2 class="mb-4" style="font-family: 'Bebas Neue', sans-serif; font-weight: 400; color: #D4A017;">Select Showtime</h2>
    <form method="get" id="dateform">
        <div class="row mb-4 align-items-center">
            <label for="selectdate" class="col-sm-2 col-form-label" style="font-family: 'Roboto', sans-serif; color: #D4A017;">Select Date</label>
            <div class="col-sm-4">
                <input type="date" name="date" id="selectdate" class="form-control" value="{{ date }}" min="{{ tomorrow }}" max="{{ thirty_days_later }}" required>
            </div>
        </div>
    </form>
    <div class="row">
        {% if films %}
        <p class="text-light">Showing available showtimes for {{ date }}.</p>
        {% for key, value in films.items %}
        <div class="row mb-4 align-items-center">
            <div class="col-md-2">
                <img class="img-fluid rounded" src="{{ value.url }}" alt="{{ key }}" style="height: 100px; object-fit: cover;">
            </div>
            <div class="col-md-10">
                <h3 style="font-family: 'Bebas Neue', sans-serif; color: #D4A017;">{{ key }}</h3>
                {% for showid, data in value.showtimes.items %}
                <a class="btn btn-primary me-2 mb-2 showtimebtn" data-showid="{{ showid }}" data-bs-toggle="modal" data-bs-target="#seatModal">{{ data.showtime|time:"h:i A" }} ({{ data.salle }})</a>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p class="text-light">No shows available on {{ date }}. <a href="{% url 'index' %}" class="text-warning">Browse movies</a></p>
        {% endif %}
    </div>
    <div class="modal fade" id="seatModal" tabindex="-1" aria-labelledby="seatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="seatModalLabel" style="font-family: 'Bebas Neue', sans-serif; color: #D4A017;">Book Tickets</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Hall:</strong> <span id="salle-name">Select a showtime</span></p>
                    <div class="scontainer">
                        <div class="screen"></div>
                        <hr>
                        <div id="seat-container">
                            <!-- Seats will be dynamically generated by JavaScript -->
                        </div>
                    </div>
                    <ul class="d-flex justify-content-between list-unstyled bg-dark p-2 rounded mt-3">
                        <li class="d-flex align-items-center">
                            <div style="background-color: #FFFFFF; height: 12px; width: 15px; margin: 3px; border-top-left-radius: 10px; border-top-right-radius: 10px;"></div>
                            <small style="color: #FFFFFF;">Occupied</small>
                        </li>
                        <li class="d-flex align-items-center">
                            <div style="background-color: #1C2526; height: 12px; width: 15px; margin: 3px; border-top-left-radius: 10px; border-top-right-radius: 10px;"></div>
                            <small style="color: #FFFFFF;">Available</small>
                        </li>
                        <li class="d-flex align-items-center">
                            <div style="background-color: #D4A017; height: 12px; width: 15px; margin: 3px; border-top-left-radius: 10px; border-top-right-radius: 10px;"></div>
                            <small style="color: #FFFFFF;">Selected</small>
                        </li>
                    </ul>
                </div>
                <div class="modal-footer border-0">
                    <form id="target_form" method="post" action="{% url 'checkout' %}">
                        {% csrf_token %}
                        <input type="hidden" name="showdate" id="show_date" value="{{ date }}" />
                        <input type="hidden" name="seats" id="seats_input" />
                        <input type="hidden" name="showid" id="show_id" />
                    </form>
                    <button type="button" class="btn btn-primary bookticketsbtn">Book Tickets</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .text-warning:hover {
        color: #b58913 !important;
    }
</style>
{% endblock %}
{% block js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const dateInput = document.getElementById('selectdate');
    dateInput.addEventListener('change', () => {
        if (dateInput.value) {
            document.getElementById('dateform').submit();
        }
    });

    document.querySelectorAll('.showtimebtn').forEach(button => {
        button.addEventListener('click', () => {
            const showId = button.getAttribute('data-showid');
            document.getElementById('show_id').value = showId;
            const showDate = document.getElementById('show_date').value;

            // Clear previous seats
            document.querySelectorAll('.seat.occupied, .seat.selected').forEach(seat => {
                seat.classList.remove('occupied', 'selected');
            });

            // Fetch show details (including salle capacity and name)
            fetch(`/show_details?show_id=${showId}`)
                .then(response => response.json())
                .then(data => {
                    const capacity = data.capacity;
                    const salleName = data.salle_name;
                    document.getElementById('salle-name').textContent = salleName;

                    // Generate seat layout dynamically
                    const seatContainer = document.getElementById('seat-container');
                    seatContainer.innerHTML = ''; // Clear previous seats
                    const seatsPerRow = 8; // Adjust as needed
                    const rows = Math.ceil(capacity / seatsPerRow);
                    const rowLabels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

                    for (let i = 0; i < rows; i++) {
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'srow';
                        rowDiv.innerHTML = `<div class="seatindex">${rowLabels[i]}</div>`;
                        for (let j = 1; j <= seatsPerRow && (i * seatsPerRow + j) <= capacity; j++) {
                            rowDiv.innerHTML += `<div class="seat" sno="${rowLabels[i]}${j}"></div>`;
                        }
                        seatContainer.appendChild(rowDiv);
                    }

                    // Add seat number labels
                    const numberRow = document.createElement('div');
                    numberRow.className = 'srow';
                    numberRow.innerHTML = '<div class="seatnumber"></div>';
                    for (let j = 1; j <= seatsPerRow; j++) {
                        numberRow.innerHTML += `<div class="seatnumber">${j}</div>`;
                    }
                    seatContainer.appendChild(numberRow);

                    // Re-attach event listeners to new seats
                    document.querySelectorAll('.seat').forEach(seat => {
                        seat.addEventListener('click', () => {
                            if (!seat.classList.contains('occupied')) {
                                seat.classList.toggle('selected');
                                updateSeats();
                            }
                        });
                    });

                    // Fetch booked seats
                    fetch(`/bookedseats?show_id=${showId}&show_date=${showDate}`)
                        .then(response => response.text())
                        .then(data => {
                            if (data) {
                                data.split(',').forEach(id => {
                                    const seat = document.querySelector(`.seat[sno="${id}"]`);
                                    if (seat) seat.classList.add('occupied');
                                });
                            }
                        });
                });
        });
    });

    function updateSeats() {
        const selected = Array.from(document.querySelectorAll('.seat.selected')).map(seat => seat.getAttribute('sno'));
        document.getElementById('seats_input').value = selected.join(',');
    }

    document.querySelector('.bookticketsbtn').addEventListener('click', () => {
        document.getElementById('target_form').submit();
    });
});
</script>
{% endblock %}